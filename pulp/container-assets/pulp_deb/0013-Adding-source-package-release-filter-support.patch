From e66c8a39417e912a3c8267e5a37e8cfdf860d690 Mon Sep 17 00:00:00 2001
From: Moustafa Moustafa <momousta@microsoft.com>
Date: Fri, 28 Apr 2023 14:15:12 -0400
Subject: [PATCH] Adding source package release filter support

---
 pulp_deb/app/viewsets/content.py | 38 +++++++++++++++++++++++++++-----
 1 file changed, 32 insertions(+), 6 deletions(-)

diff --git a/pulp_deb/app/viewsets/content.py b/pulp_deb/app/viewsets/content.py
index df22de8..ecb18e9 100644
--- a/pulp_deb/app/viewsets/content.py
+++ b/pulp_deb/app/viewsets/content.py
@@ -126,16 +126,19 @@ class ContentRelationshipFilter(Filter):
             raise ValidationError(detail=_("Invalid value supplied for content filter"))
 
         prc_qs = models.PackageReleaseComponent.objects.filter(pk__in=repo_version.content)
+        sprc_qs = models.SourcePackageReleaseComponent.objects.filter(pk__in=repo_version.content)
 
-        return self._filter(qs, my_value, prc_qs)
+        return self._filter(qs, my_value, prc_qs, sprc_qs)
 
-    def _filter(self, qs, value, prc_qs):
+    def _filter(self, qs, value, prc_qs, sprc_qs):
         """
         Args:
             qs (django.db.models.query.QuerySet): The Content Queryset
             value (string): The values to filter by
             prc_qs (django.db.models.query.QuerySet): QuerySet of PackageReleaseComponents in
                 requested RepositoryVersion
+            sprc_qs (django.db.models.query.QuerySet): QuerySet of SourcePackageReleaseComponents
+                in requested RepositoryVersion
         """
         raise NotImplementedError
 
@@ -144,7 +147,7 @@ class PackageToReleaseComponentFilter(ContentRelationshipFilter):
     HELP = "Filter results where Package in ReleaseComponent"
     ARG = "release_component_href"
 
-    def _filter(self, qs, value, prc_qs):
+    def _filter(self, qs, value, prc_qs, sprc_qs):
         rc = NamedModelViewSet.get_resource(value, models.structure_content.ReleaseComponent)
         prc_qs = prc_qs.filter(release_component__pk=rc.pk)
         return qs.filter(deb_packagereleasecomponent__in=prc_qs)
@@ -154,12 +157,32 @@ class PackageToReleaseFilter(ContentRelationshipFilter):
     HELP = "Filter results where Package in Release"
     ARG = "release_href"
 
-    def _filter(self, qs, value, prc_qs):
+    def _filter(self, qs, value, prc_qs, sprc_qs):
         r = NamedModelViewSet.get_resource(value, models.structure_content.Release)
         prc_qs = prc_qs.filter(release_component__release__pk=r.pk)
         return qs.filter(deb_packagereleasecomponent__in=prc_qs)
 
 
+class SourcePackageToReleaseComponentFilter(ContentRelationshipFilter):
+    HELP = "Filter results where SourcePackage in ReleaseComponent"
+    ARG = "release_component_href"
+
+    def _filter(self, qs, value, prc_qs, sprc_qs):
+        rc = NamedModelViewSet.get_resource(value, models.structure_content.ReleaseComponent)
+        sprc_qs = sprc_qs.filter(release_component__pk=rc.pk)
+        return qs.filter(deb_sourcepackagereleasecomponent__in=sprc_qs)
+
+
+class SourcePackageToReleaseFilter(ContentRelationshipFilter):
+    HELP = "Filter results where SourcePackage in Release"
+    ARG = "release_href"
+
+    def _filter(self, qs, value, prc_qs, sprc_qs):
+        r = NamedModelViewSet.get_resource(value, models.structure_content.Release)
+        sprc_qs = sprc_qs.filter(release_component__release__pk=r.pk)
+        return qs.filter(deb_sourcepackagereleasecomponent__in=sprc_qs)
+
+
 class PackageFilter(ContentFilter):
     """
     FilterSet for Package.
@@ -376,7 +399,7 @@ class ReleaseToPackageFilter(ContentRelationshipFilter):
     HELP = "Filter results where Release contains Package"
     ARG = "package_href"
 
-    def _filter(self, qs, value, prc_qs):
+    def _filter(self, qs, value, prc_qs, sprc_qs):
         p = NamedModelViewSet.get_resource(value, models.content.Package)
         prc_qs = prc_qs.filter(package__pk=p.pk)
         return qs.filter(deb_releasecomponent__deb_packagereleasecomponent__in=prc_qs)
@@ -445,7 +468,7 @@ class ReleaseComponentToPackageFilter(ContentRelationshipFilter):
     HELP = "Filter results where ReleaseComponent contains Package"
     ARG = "package_href"
 
-    def _filter(self, qs, value, prc_qs):
+    def _filter(self, qs, value, prc_qs, sprc_qs):
         p = NamedModelViewSet.get_resource(value, models.content.Package)
         prc_qs = prc_qs.filter(package__pk=p.pk)
         return qs.filter(deb_packagereleasecomponent__in=prc_qs)
@@ -511,6 +534,9 @@ class SourcePackageFilter(ContentFilter):
     FilterSet for Debian Source Packages.
     """
 
+    release_component = SourcePackageToReleaseComponentFilter()
+    release = SourcePackageToReleaseFilter()
+
     class Meta:
         model = models.SourcePackage
         fields = [
-- 
2.31.1

