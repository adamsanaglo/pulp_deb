From 3eb571d6f0f33cd9e6e89a299d15d272bedffd6f Mon Sep 17 00:00:00 2001
From: David Davis <daviddavis@microsoft.com>
Date: Mon, 17 Oct 2022 17:04:18 +0000
Subject: [PATCH] Merged PR 6941077: Apply release fields feature to pulp_deb

Apply the commit from https://github.com/pulp/pulp_deb/pull/656
---
 CHANGES/449.feature                           |  2 +
 .../app/migrations/0020_add_release_fields.py | 61 +++++++++++++++++++
 pulp_deb/app/models/metadata_content.py       |  8 +++
 pulp_deb/app/models/structure_content.py      |  8 ++-
 .../app/serializers/content_serializers.py    | 49 +++++++++++++--
 pulp_deb/app/tasks/publishing.py              | 10 +--
 pulp_deb/app/tasks/synchronizing.py           | 16 ++++-
 pulp_deb/app/viewsets/content.py              |  2 +-
 8 files changed, 145 insertions(+), 11 deletions(-)
 create mode 100644 pulp/container-assets/pulp_deb/CHANGES/449.feature
 create mode 100644 pulp/container-assets/pulp_deb/pulp_deb/app/migrations/0020_add_release_fields.py

diff --git a/CHANGES/449.feature b/CHANGES/449.feature
new file mode 100644
index 0000000..7720322
--- /dev/null
+++ b/CHANGES/449.feature
@@ -0,0 +1,2 @@
+Added ``version``, ``origin``, ``label``, and ``description`` fields to Releases.
+Also added a unique constraint per repo on Release distribution field.
diff --git a/pulp_deb/app/migrations/0020_add_release_fields.py b/pulp_deb/app/migrations/0020_add_release_fields.py
new file mode 100644
index 0000000..7451677
--- /dev/null
+++ b/pulp_deb/app/migrations/0020_add_release_fields.py
@@ -0,0 +1,61 @@
+# Generated by Django 3.2.16 on 2022-10-15 11:41
+
+from django.db import migrations, models
+
+
+class Migration(migrations.Migration):
+
+    dependencies = [
+        ('deb', '0019_immutable_metadata_constraints'),
+    ]
+
+    operations = [
+        migrations.AddField(
+            model_name='release',
+            name='description',
+            field=models.TextField(null=True),
+        ),
+        migrations.AddField(
+            model_name='release',
+            name='label',
+            field=models.TextField(null=True),
+        ),
+        migrations.AddField(
+            model_name='release',
+            name='origin',
+            field=models.TextField(null=True),
+        ),
+        migrations.AddField(
+            model_name='release',
+            name='version',
+            field=models.TextField(null=True),
+        ),
+        migrations.AddField(
+            model_name='releasefile',
+            name='description',
+            field=models.TextField(null=True),
+        ),
+        migrations.AddField(
+            model_name='releasefile',
+            name='label',
+            field=models.TextField(null=True),
+        ),
+        migrations.AddField(
+            model_name='releasefile',
+            name='origin',
+            field=models.TextField(null=True),
+        ),
+        migrations.AddField(
+            model_name='releasefile',
+            name='version',
+            field=models.TextField(null=True),
+        ),
+        migrations.AlterUniqueTogether(
+            name='release',
+            unique_together={('codename', 'suite', 'distribution', 'version', 'origin', 'label', 'description')},
+        ),
+        migrations.AlterUniqueTogether(
+            name='releasefile',
+            unique_together={('codename', 'suite', 'distribution', 'origin', 'label', 'components', 'architectures', 'relative_path', 'sha256', 'artifact_set_sha256')},
+        ),
+    ]
diff --git a/pulp_deb/app/models/metadata_content.py b/pulp_deb/app/models/metadata_content.py
index f716a77..c0bd5e5 100644
--- a/pulp_deb/app/models/metadata_content.py
+++ b/pulp_deb/app/models/metadata_content.py
@@ -19,6 +19,10 @@ class ReleaseFile(Content):
     codename = models.TextField()
     suite = models.TextField()
     distribution = models.TextField()
+    version = models.TextField(null=True)
+    origin = models.TextField(null=True)
+    label = models.TextField(null=True)
+    description = models.TextField(null=True)
     components = models.TextField(blank=True)
     architectures = models.TextField(blank=True)
     relative_path = models.TextField()
@@ -32,6 +36,10 @@ class ReleaseFile(Content):
                 "codename",
                 "suite",
                 "distribution",
+                "version",
+                "origin",
+                "label",
+                "description",
                 "components",
                 "architectures",
                 "relative_path",
diff --git a/pulp_deb/app/models/structure_content.py b/pulp_deb/app/models/structure_content.py
index 4ff17a4..9849e09 100644
--- a/pulp_deb/app/models/structure_content.py
+++ b/pulp_deb/app/models/structure_content.py
@@ -22,10 +22,16 @@ class Release(Content):
     codename = models.TextField()
     suite = models.TextField()
     distribution = models.TextField()
+    version = models.TextField(null=True)
+    origin = models.TextField(null=True)
+    label = models.TextField(null=True)
+    description = models.TextField(null=True)
 
     class Meta:
         default_related_name = "%(app_label)s_%(model_name)s"
-        unique_together = (("codename", "suite", "distribution"),)
+        unique_together = (
+            ("codename", "suite", "distribution", "version", "origin", "label", "description"),
+        )
 
 
 class ReleaseArchitecture(Content):
diff --git a/pulp_deb/app/serializers/content_serializers.py b/pulp_deb/app/serializers/content_serializers.py
index 8b5ef65..91139c0 100644
--- a/pulp_deb/app/serializers/content_serializers.py
+++ b/pulp_deb/app/serializers/content_serializers.py
@@ -101,12 +101,37 @@ class ReleaseFileSerializer(MultipleArtifactContentSerializer):
     A serializer for ReleaseFile.
     """
 
-    codename = CharField(help_text='Codename of the release, i.e. "buster".', required=False)
+    codename = CharField(help_text='Codename of the release, e.g. "buster".', required=False)
 
-    suite = CharField(help_text='Suite of the release, i.e. "stable".', required=False)
+    suite = CharField(help_text='Suite of the release, e.g. "stable".', required=False)
 
     distribution = CharField(
-        help_text='Distribution of the release, i.e. "stable/updates".', required=True
+        help_text='Distribution of the release, e.g. "stable/updates".', required=True
+    )
+
+    version = CharField(
+        help_text='Version of the release, e.g. "1.0".',
+        required=False,
+        allow_null=True,
+        default=None,
+    )
+
+    origin = CharField(
+        help_text="Origin of the release.",
+        required=False,
+        allow_null=True,
+        default=None,
+    )
+
+    label = CharField(
+        help_text="Release label.",
+        required=False,
+        allow_null=True,
+        default=None,
+    )
+
+    description = CharField(
+        help_text="Description of the release.", required=False, allow_null=True, default=None
     )
 
     relative_path = CharField(help_text="Path of file relative to url.", required=False)
@@ -116,6 +141,10 @@ class ReleaseFileSerializer(MultipleArtifactContentSerializer):
             "codename",
             "suite",
             "distribution",
+            "version",
+            "origin",
+            "label",
+            "description",
             "relative_path",
         )
         model = ReleaseFile
@@ -611,10 +640,22 @@ class ReleaseSerializer(NoArtifactContentSerializer):
     codename = CharField()
     suite = CharField()
     distribution = CharField()
+    version = CharField(required=False, allow_null=True, default=None)
+    origin = CharField(required=False, allow_null=True, default=None)
+    label = CharField(required=False, allow_null=True, default=None)
+    description = CharField(required=False, allow_null=True, default=None)
 
     class Meta(NoArtifactContentSerializer.Meta):
         model = Release
-        fields = NoArtifactContentSerializer.Meta.fields + ("codename", "suite", "distribution")
+        fields = NoArtifactContentSerializer.Meta.fields + (
+            "codename",
+            "suite",
+            "distribution",
+            "version",
+            "origin",
+            "label",
+            "description",
+        )
 
 
 class ReleaseArchitectureSerializer(NoArtifactContentSerializer):
diff --git a/pulp_deb/app/tasks/publishing.py b/pulp_deb/app/tasks/publishing.py
index d812282..60d0623 100644
--- a/pulp_deb/app/tasks/publishing.py
+++ b/pulp_deb/app/tasks/publishing.py
@@ -160,10 +160,11 @@ def publish(repository_version_pk, simple=False, structured=False, signing_servi
                         distribution=release.distribution,
                         components=components.values_list("component", flat=True),
                         architectures=architectures,
-                        description=repository.description,
-                        label=repository.name,
-                        version=str(repo_version.number),
+                        description=release.description or repository.description,
+                        label=release.label or repository.name,
+                        version=release.version or str(repo_version.number),
                         suite=release.suite,
+                        origin=release.origin,
                     )
 
                     for prc in PackageReleaseComponent.objects.filter(
@@ -244,6 +245,7 @@ class _ReleaseHelper:
         version,
         description=None,
         suite=None,
+        origin=None,
     ):
         self.publication = publication
         self.distribution = distribution
@@ -255,7 +257,7 @@ class _ReleaseHelper:
         # published Release file. As a "nice to have" for human readers, we try to use
         # the same order of fields that official Debian repositories use.
         self.release = deb822.Release()
-        self.release["Origin"] = "Pulp 3"
+        self.release["Origin"] = origin or "Pulp 3"
         if settings.PUBLISH_RELEASE_FILE_LABEL:
             self.release["Label"] = label
         if suite:
diff --git a/pulp_deb/app/tasks/synchronizing.py b/pulp_deb/app/tasks/synchronizing.py
index 68198df..e903550 100644
--- a/pulp_deb/app/tasks/synchronizing.py
+++ b/pulp_deb/app/tasks/synchronizing.py
@@ -384,6 +384,14 @@ class DebUpdateReleaseFileAttributes(Stage):
                         release_file.codename = release_file_dict["Codename"]
                     if "suite" in release_file_dict:
                         release_file.suite = release_file_dict["Suite"]
+                    if "version" in release_file_dict:
+                        release_file.version = release_file_dict["Version"]
+                    if "origin" in release_file_dict:
+                        release_file.origin = release_file_dict["Origin"]
+                    if "label" in release_file_dict:
+                        release_file.label = release_file_dict["Label"]
+                    if "description" in release_file_dict:
+                        release_file.description = release_file_dict["Description"]
 
                     if "components" in release_file_dict:
                         release_file.components = release_file_dict["Components"]
@@ -610,7 +618,13 @@ class DebFirstStage(Stage):
                 return
 
         release_unit = Release(
-            codename=release_file.codename, suite=release_file.suite, distribution=distribution
+            codename=release_file.codename,
+            suite=release_file.suite,
+            distribution=distribution,
+            version=release_file.version,
+            origin=release_file.origin,
+            label=release_file.label,
+            description=release_file.description,
         )
         release_dc = DeclarativeContent(content=release_unit)
         release = await self._create_unit(release_dc)
diff --git a/pulp_deb/app/viewsets/content.py b/pulp_deb/app/viewsets/content.py
index e7da3f4..f8dd639 100644
--- a/pulp_deb/app/viewsets/content.py
+++ b/pulp_deb/app/viewsets/content.py
@@ -344,7 +344,7 @@ class ReleaseFilter(ContentFilter):
 
     class Meta:
         model = models.Release
-        fields = ["codename", "suite", "distribution"]
+        fields = ["codename", "suite", "distribution", "version", "label", "origin"]
 
 
 class ReleaseViewSet(ContentViewSet):
-- 
2.31.1

