From ea9fb8cc3e32026d5267a12965c8ef7b87d6d2c5 Mon Sep 17 00:00:00 2001
From: Stephen Herr <stephenherr@microsoft.com>
Date: Wed, 7 Dec 2022 15:58:23 -0500
Subject: [PATCH] Store release signing overrides on repo to avoid sync issues

---
 .../app/migrations/0022_auto_20221207_2130.py | 26 +++++++++++++++++
 pulp_deb/app/models/repository.py             | 14 ++++++++-
 pulp_deb/app/models/structure_content.py      | 16 ++--------
 .../app/serializers/content_serializers.py    | 12 --------
 .../app/serializers/repository_serializers.py | 29 ++++++++++++++++++-
 pulp_deb/app/tasks/publishing.py              |  2 +-
 6 files changed, 70 insertions(+), 29 deletions(-)
 create mode 100644 pulp_deb/app/migrations/0022_auto_20221207_2130.py

diff --git a/pulp_deb/app/migrations/0022_auto_20221207_2130.py b/pulp_deb/app/migrations/0022_auto_20221207_2130.py
new file mode 100644
index 0000000..5451311
--- /dev/null
+++ b/pulp_deb/app/migrations/0022_auto_20221207_2130.py
@@ -0,0 +1,26 @@
+# Generated by Django 3.2.16 on 2022-12-07 21:30
+
+from django.db import migrations, models
+
+
+class Migration(migrations.Migration):
+
+    dependencies = [
+        ('deb', '0021_add_default_signing_service'),
+    ]
+
+    operations = [
+        migrations.AddField(
+            model_name='aptrepository',
+            name='signing_service_release_overrides',
+            field=models.JSONField(default=dict),
+        ),
+        migrations.AlterUniqueTogether(
+            name='release',
+            unique_together={('codename', 'suite', 'distribution', 'version', 'origin', 'label', 'description')},
+        ),
+        migrations.RemoveField(
+            model_name='release',
+            name='signing_service',
+        ),
+    ]
diff --git a/pulp_deb/app/models/repository.py b/pulp_deb/app/models/repository.py
index 390ef35..328d0ce 100644
--- a/pulp_deb/app/models/repository.py
+++ b/pulp_deb/app/models/repository.py
@@ -1,6 +1,5 @@
 from django.db import models
 from pulpcore.plugin.models import Repository
-
 from pulpcore.plugin.repo_version_utils import remove_duplicates, validate_version_paths
 
 from pulp_deb.app.models import (
@@ -44,10 +43,23 @@ class AptRepository(Repository):
     signing_service = models.ForeignKey(
         AptReleaseSigningService, on_delete=models.PROTECT, null=True
     )
+    signing_service_release_overrides = models.JSONField(default=dict)
 
     class Meta:
         default_related_name = "%(app_label)s_%(model_name)s"
 
+    def release_signing_service(self, release):
+        """
+        Resolve and return the Signing Service specified in the overrides if there is one for this
+        release, else return self.signing_service.
+        """
+        from pulpcore.plugin.viewsets import NamedModelViewSet
+
+        if release.distribution in self.signing_service_release_overrides:
+            url = self.signing_service_release_overrides[release.distribution]
+            return NamedModelViewSet().get_resource(url, AptReleaseSigningService)
+        return self.signing_service
+
     def initialize_new_version(self, new_version):
         """
         Remove old metadata from the repo before performing anything else for the new version. This
diff --git a/pulp_deb/app/models/structure_content.py b/pulp_deb/app/models/structure_content.py
index 7ea9125..9849e09 100644
--- a/pulp_deb/app/models/structure_content.py
+++ b/pulp_deb/app/models/structure_content.py
@@ -4,7 +4,7 @@ from django.db import models
 
 from pulpcore.plugin.models import Content
 
-from pulp_deb.app.models import AptReleaseSigningService, Package
+from pulp_deb.app.models import Package
 
 
 BOOL_CHOICES = [(True, "yes"), (False, "no")]
@@ -26,23 +26,11 @@ class Release(Content):
     origin = models.TextField(null=True)
     label = models.TextField(null=True)
     description = models.TextField(null=True)
-    signing_service = models.ForeignKey(
-        AptReleaseSigningService, on_delete=models.PROTECT, null=True
-    )
 
     class Meta:
         default_related_name = "%(app_label)s_%(model_name)s"
         unique_together = (
-            (
-                "codename",
-                "suite",
-                "distribution",
-                "version",
-                "origin",
-                "label",
-                "description",
-                "signing_service",
-            ),
+            ("codename", "suite", "distribution", "version", "origin", "label", "description"),
         )
 
 
diff --git a/pulp_deb/app/serializers/content_serializers.py b/pulp_deb/app/serializers/content_serializers.py
index 6ad90a2..0b41de7 100644
--- a/pulp_deb/app/serializers/content_serializers.py
+++ b/pulp_deb/app/serializers/content_serializers.py
@@ -10,14 +10,12 @@ from pulpcore.plugin.serializers import (
     ContentChecksumSerializer,
     MultipleArtifactContentSerializer,
     NoArtifactContentSerializer,
-    RelatedField,
     SingleArtifactContentSerializer,
     SingleArtifactContentUploadSerializer,
     DetailRelatedField,
 )
 
 from pulp_deb.app.models import (
-    AptReleaseSigningService,
     BasePackage,
     GenericContent,
     InstallerFileIndex,
@@ -646,15 +644,6 @@ class ReleaseSerializer(NoArtifactContentSerializer):
     origin = CharField(required=False, allow_null=True, default=None)
     label = CharField(required=False, allow_null=True, default=None)
     description = CharField(required=False, allow_null=True, default=None)
-    signing_service = RelatedField(
-        help_text="A reference to an associated signing service. Overrides "
-        "AptRepository.signing_service but not AptPublication.signing_service.",
-        view_name="signing-services-detail",
-        queryset=AptReleaseSigningService.objects.all(),
-        many=False,
-        required=False,
-        allow_null=True,
-    )
 
     class Meta(NoArtifactContentSerializer.Meta):
         model = Release
@@ -666,7 +655,6 @@ class ReleaseSerializer(NoArtifactContentSerializer):
             "origin",
             "label",
             "description",
-            "signing_service",
         )
 
 
diff --git a/pulp_deb/app/serializers/repository_serializers.py b/pulp_deb/app/serializers/repository_serializers.py
index 088a6bb..c86aa6b 100644
--- a/pulp_deb/app/serializers/repository_serializers.py
+++ b/pulp_deb/app/serializers/repository_serializers.py
@@ -5,6 +5,7 @@ from pulpcore.plugin.serializers import (
     RepositorySyncURLSerializer,
     validate_unknown_fields,
 )
+from pulpcore.plugin.viewsets import NamedModelViewSet
 
 from pulp_deb.app.models import AptReleaseSigningService, AptRepository
 
@@ -27,11 +28,37 @@ class AptRepositorySerializer(RepositorySerializer):
         required=False,
         allow_null=True,
     )
+    signing_service_release_overrides = serializers.JSONField(
+        required=False,
+        default=dict,
+        help_text=_(
+            "A dictionary of Release distributions and the Signing Service URLs they should use."
+            'Example: {"bionic": "/pulp/api/v3/signing-services/433a1f70-c589-4413-a803-c50b842ea9b5/"}'
+        ),
+    )
 
     class Meta:
-        fields = RepositorySerializer.Meta.fields + ("signing_service",)
+        fields = RepositorySerializer.Meta.fields + (
+            "signing_service",
+            "signing_service_release_overrides",
+        )
         model = AptRepository
 
+    def validate(self, data):
+        """
+        Validate that the Serializer contains valid data.
+        Ensure the signing services specified in signing_service_release_overrides exist, or error.
+        """
+        super().validate(data)
+
+        field = "signing_service_release_overrides"
+        if field in data:
+            nmvs = NamedModelViewSet()
+            for _, value in data[field].items():
+                nmvs.get_resource(value, AptReleaseSigningService)
+
+        return data
+
 
 class AptRepositorySyncURLSerializer(RepositorySyncURLSerializer):
     """
diff --git a/pulp_deb/app/tasks/publishing.py b/pulp_deb/app/tasks/publishing.py
index 0948643..4fd884c 100644
--- a/pulp_deb/app/tasks/publishing.py
+++ b/pulp_deb/app/tasks/publishing.py
@@ -170,7 +170,7 @@ def publish(repository_version_pk, simple=False, structured=False, signing_servi
                         version=release.version or str(repo_version.number),
                         suite=release.suite,
                         origin=release.origin,
-                        signing_service=(release.signing_service or repository.signing_service),
+                        signing_service=repository.release_signing_service(release),
                     )
 
                     for prc in PackageReleaseComponent.objects.filter(
-- 
2.31.1

