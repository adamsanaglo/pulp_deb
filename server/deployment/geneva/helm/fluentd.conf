# This file collects, filters and sends logs to Geneva. You should modify it according to your specific needs.

@include kubernetes.conf

# Match tags generated by the kubernetes.conf config that correspond with one of our "application
# containers". Retag them as "pmclogs.{container_name}" for streaming to mdsd / geneva.
<match kubernetes.var.log.containers.{api-pod,worker-pod,pulp-content,nginx-content,nginx-api}**.log>
  @type rewrite_tag_filter
  <rule>
    key     ContainerName
    pattern ^(.+)$
    tag     pmclogs.$1
  </rule>
</match>

# Drop the endpoint monitor pings, because they're worthless and noisy
<filter pmclogs.nginx-content>
  @type grep
  <exclude>
    key log
    pattern "Azure Traffic Manager Endpoint Monitor"
  </exclude>
</filter>

# Filter out ip address from the containers that log it
<filter pmclogs.{nginx-content,pulp-content,pmc}>
  @type record_transformer
  enable_ruby
  <record>
    log ${record["log"].gsub(/(?:[0-9]{1,3}\.){3}[0-9]{1,3}/,'REDACTED_IP_ADDRESS')}
  </record>
</filter>

# Retag to prefix all other container events with k8scontainers
<match kubernetes.var.log.containers.**.log>
  @type rewrite_tag_filter
  <rule>
    key     ContainerName
    pattern ^(.+)$
    tag     k8scontainers.$1
  </rule>
</match>

# Send pmclogs events to MDSD
<match pmclogs.**>
  @type mdsd
  @log_level info
  djsonsocket /var/run/mdsd/default_djson.socket  # Full path to mdsd dynamic json socket file
  acktimeoutms 5000  # max time in milliseconds to wait for mdsd acknowledge response. If 0, no wait.
  mdsd_tag_regex_patterns ["^pmclogs\.\w+"]  # fluentd tag patterns whose match will be used as mdsd source name
  num_threads 1
  buffer_chunk_limit 1000k
  buffer_type file
  buffer_path /var/log/td-agent/buffer/out_pmclogs*.buffer
  buffer_queue_limit 128
  flush_interval 10s
  retry_limit 3
  retry_wait 10s
</match>

# Send all other kubernetes container events to MDSD
<match k8scontainers.**>
  @type mdsd
  @log_level info
  djsonsocket /var/run/mdsd/default_djson.socket  # Full path to mdsd dynamic json socket file
  acktimeoutms 5000  # max time in milliseconds to wait for mdsd acknowledge response. If 0, no wait.
  mdsd_tag_regex_patterns ["^k8scontainers"]  # fluentd tag patterns whose match will be used as mdsd source name
  num_threads 1
  buffer_chunk_limit 1000k
  buffer_type file
  buffer_path /var/log/td-agent/buffer/out_k8scontainers*.buffer
  buffer_queue_limit 128
  flush_interval 10s
  retry_limit 3
  retry_wait 10s
</match>

# Anything else goes to standard output
<match **>
  @type stdout
</match>