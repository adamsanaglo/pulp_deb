# PMC Status Monitoring

The PMC status monitoring project provides an automated tool for checking and displaying the status of **mirrors** and **repositories**. There are two primary components to this project, the [backend Azure Functions](functions/) that check status and publish the status to a JSON, and [frontend website](website/) that displays the status. 

## Dependency on Repoaudit command line tool

[Repoaudit](https://github.com/microsoft/linux-package-repositories) is a publicly available commandline tool on GitHub developed by the PMC team that checks for repository errors. It is also available as a python module on [PyPI](https://pypi.org/project/repoaudit/). Repository status generated by the Azure Function backend uses the repoaudit codebase as an imported module. 

## pmcstatusprimary Azure Storage Account

The **pmcstatusprimary** storage account holds the containers, blobs, static site content, and queues necessary for the status monitoring to work. 

### Containers
- $web
    - Public access level: `Private`
    - Contains website files in `status/website/site-content`:

        ```
        - 404.html
        - apt.html
        - mirror.html
        - refresh.svg
        - script.js
        - style.css
        - svg-check.svg
        - svg-empty.svg
        - svg-error.svg
        - yum.html
        ```

- dynamic-public-data
    - Public access level: `Blob`
    - Blob files:
        - `repository_status.json` - JSON blob that contains mirror and repository status. This is updated by the Azure functions backend. When deploying a new storage account, this file should be created as an empty json dict as follows.

            ```json
            {}
            ```

- static-data
    - Public access level: `Private`
    - Blob files
        - `mirrors.json` - JSON blob that contains a list of mirrors. This is passed to the **generate-mirrors** function in the **pmc_scan_mirrors** function app. Example format:

            ```json
            [
                "<mirror1_url>",
                "<mirror2_url>",
                ...
                "<mirrorN_url>",
            ]
            ```
        - `pubkeys.json` - JSON blob that contains a list of public key URL's. This is passed to the **check_apt_repo/check_yum_repo** functions in the **pmc_scan_repos** function app. Example format:

            ```json
            [
                "https://packages.microsoft.com/keys/microsoft.asc", 
                "https://packages.microsoft.com/keys/msopentech.asc"
            ]
            ```

### Queues
Queues do not have to be manually created. When a function adds a message to a queue, it will also initialize the queue if it doesn't exist already. 
- repo-request-queue
    - Requests to check an apt or yum repository are added to this queue. 
    - Message format for apt ("dists" entry is optional):

        ```json
        {
            "type": "apt",
            "repo": "<repo_url>",
            "dists": ["<dist1>,..,<distn>"]
        }
        ```
    - Message format for yum:

        ```json
        {
            "type": "yum",
            "repo": "<repo_url>"
        }
        ```
- mirror-request-queue
    - Requests to check a mirror are added to this queue.
    - Message format:

        ```
        <mirror_url>
        ```
- results-queue
    - Mirror and repository status results are added to this queue to trigger a function to update `repository_status.json`. 
    - Message format:

        ```json
        {
            "status_type": "apt"/"yum"/"mirror"/"apt-list"/"yum-list"/"mirror-list"
            "status": <status_update>
        }
        ```

### Static website configuration
These setting are already configured when deploying the website following the steps in the website [readme](website/README.md)
- Status website: Enabled
- Index document name: `mirror.html`
- Error document path: `404.html`